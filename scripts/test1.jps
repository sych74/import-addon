type: update
name: Standalone Pro

baseUrl: https://raw.githubusercontent.com/sych74/import-addon/WP-349
  
globals:
  wp_admin_pass: ${fn.password(10)}
  db_user: user-${fn.random}
  db_pass: ${fn.password(10)}
  env_name: wp-${fn.random}
  envGroups: "${settings.envGroups}"
  project_name: "${settings.project_name}"
  migration_dir: "/home/jelastic/migrator"
  wpenv_file: "/home/jelastic/migrator/.wpenv"
  wpenv_file_content: "${settings.wpenv_file_content}"
  projects_file: "/home/jelastic/migrator/projects.json"
  projects_file_content: "${settings.projects_file_content}"

nodes:
- nodeType: nginxphp
  
onInstall:
  - log: ------ ${globals.projects_file_content}

actions:
 
  addConfigs:
    - script: | 
        var envInfo = jelastic.env.control.GetEnvInfo('${globals.env_name}', session);
        if (envInfo.result != 0) return envInfo;
        for (var i = 0, k = envInfo.nodes; i < k.length; i++) {
          if (k[i].nodeGroup == 'cp')
            master_id = k[i].id;
        }       
        var cmd1 = "echo '${globals.wpenv_file_content}' > ${globals.wpenv_file};";
        var cmd2 = "echo 'PROJECT_NAME=${globals.project_name}' >> ${globals.wpenv_file};";
        var cmd3 = "echo '${globals.projects_file_content}' > ${globals.projects_file};";
        return api.environment.control.ExecCmdById({
          envName: "${globals.env_name}", 
          session: session,
          nodeId: master_id, 
          commandList: toJSON([{"command": cmd1}, {"command": cmd2}, {"command": cmd3}])
        });
 
